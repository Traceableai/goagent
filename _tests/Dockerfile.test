# This dockerfile is only aimed to be used for testing the blocking filter

ARG TRACEABLE_GOAGENT_DISTRO_VERSION

FROM traceable_goagent_test_base:${TRACEABLE_GOAGENT_DISTRO_VERSION}

WORKDIR /go/src/github.com/Traceableai/goagent

COPY . .

# We move the libtraceable into the root of the build root dir because the blocking package
# expects the library to be in the root.
# See https://github.com/Traceableai/goagent/blob/main/filters/blocking/blocking.go#L7
RUN mv /usr/local/libtraceable-downloader/lib/libtraceable.so ./libtraceable.so

# Go get expects the library to be present when retrieving the dependencies
RUN go get ./...

RUN CGO_ENABLED=1 go test -c ./filters/blocking

# Once the test is compiled we need to pass the LD_LIBRARY_PATH specifying the library
# location.
RUN LD_LIBRARY_PATH=./ ./blocking.test

WORKDIR /go/src/github.com/Traceableai/goagent/_tests

RUN go build -o test-app .

RUN LD_LIBRARY_PATH=../ ./test-app
